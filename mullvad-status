#!/bin/bash

MULLVAD_API_ENDPOINT=https://am.i.mullvad.net/json
ICONS_DIR=~/.cache/mullvad-status
ICONS_SIZE=32
TEXT="Unknown."

ICON_ON='<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56"  stroke="none" stroke-linecap="round" stroke-linejoin="round" fill="#000" fill-rule="evenodd"><path d="M.1067 27.0612c0 14.8965 12.0794 26.9546 26.9545 26.9546s26.9546-12.0581 26.9546-26.9546S41.9577.1067 27.0612.1067.1067 12.1647.1067 27.0612h0z" fill="#fff"/><path d="M3.7134 23.8387l2.0488-2.8598-.128 4.1189.5762-3.0945c1.7073 3.4574 5.8903 8.2379 9.7105 10.7989.4055.2774.7469.5762.9817.875.4909.1921.9817.2988 1.4726.3841.2561.0427.5335.0641.7896.0854s.5336.0214.7897.0214.5122-.0214.7683-.0427.5122-.0641.7682-.1067.5123-.0854.747-.1708c.2561-.064.4909-.128.747-.2134.2347-.064.4908-.1707.7256-.2561.2348-.1067.4695-.1921.7043-.3201s.4695-.2348.6829-.3628c.2348-.1067.4482-.2561.6829-.3842s.4482-.2774.683-.4054.4482-.2775.6616-.4056c.2134-.1493.4481-.2774.6616-.4268s.4481-.2774.6829-.4268l.2134-.1281.1067.0641 1.5366 1.0244-1.5579-.4055c-.1494.1707-.2988.3414-.4695.5122-.1921.1921-.4055.3841-.5976.5762-.2134.1707-.4269.3628-.6616.5122-.2348.1707-.4482.3201-.7043.4695-.4695.2988-.9817.5549-1.5152.7683-.2561.1067-.5336.2134-.7897.2988-.2774.0854-.5335.1707-.811.2347s-.5549.1281-.8323.1708-.5549.064-.8323.1067c-.5549.0213-1.1311.0213-1.686-.064-.2774-.0427-.5549-.0854-.8323-.1494s-.5336-.1494-.7897-.2348c-.4482-.1707-.8963-.3841-1.3018-.6402 0 0-1.4726.2134-.875 1.3232s1.4939 1.003 1.0671 2.3049c-.2988.7042-.7257 1.3872-1.1952 2.0274-.9817 1.3232-2.5183 2.497-2.3689 3.2013 6.9787 8.6007 22.7075 7.4055 28.6832-.2775-.0853-1.1098-1.8354-1.6433-3.0518-4.3537.3414.1067.8536.2561.8536.2348s-1.4512-2.3689-1.5152-2.6037l.939.064s-1.2378-1.5366-1.2805-1.686l1.2591-.1707s-1.5792-1.8141-1.6006-1.9634l1.6006.2561-1.75-2.1129h.8324l-.9817-1.4299c-.1708-.064-.3415-.1067-.5122-.1493l-.6403-.1921c-2.3903-.747-4.6525-1.4299-6.8294-2.7958-3.0518-1.8994-5.7836-4.2256-7.8324-6.0397l-4.1189-2.0061c-3.9482-.2988-7.6617-.1921-9.9239.2561l1.4513-2.4757-2.2196 2.6678c-.1494-.0427-.1921-.1281-.1921-.1281l.1495-3.2866-.7043 2.9665c-.2134-.1067-.4695-.1494-.7256-.1494a1.767 1.767 0 0 0-1.7714 1.7714c0 .8963.6616 1.6433 1.5366 1.75l-1.5153 3.0732z"/><path d="M6.1891 17.3508c-.2134-.0854-.4695-.1494-.7042-.1494a1.767 1.767 0 0 0-1.7714 1.7714c0 .8536.6189 1.5792 1.4299 1.75h.0427c.5335-.1708 1.6006-1.6007 1.4299-2.497-.064-.3201-.2134-.6189-.4269-.875h0zm15.5582-2.2836c-.3201-.875-.2348-2.0061.2134-3.0732.6402-1.4725 1.8567-2.4543 3.0092-2.4543a1.738 1.738 0 0 1 .6615.1281c.6616-.5976 1.4299-1.0884 2.2836-1.4299 4.7165-1.8781 11.6099 1.4726 13.3812 6.1037.8537 2.2409.5976 4.6952-.128 6.9361-.5976 1.8353-2.7744 4.4817-1.9634 6.4878-.3201-.0853-7.0641-2.1768-8.9422-3.372-3.0092-1.878-5.7196-4.1829-7.747-5.9756l-.0641-.064-6.8506-3.244c-.0854-.0427-.1708-.0854-.2348-.128.9817 0 4.7165.4481 6.3812.0853"/><g fill-rule="nonzero"><path d="M23.7746 15.8355c-.1921 0-.3628-.0427-.4908-.1067-.3415-.1494-.5976-.4268-.7684-.8536-.2987-.7257-.2134-1.7287.1921-2.6678.5336-1.2164 1.5366-2.0701 2.4543-2.0701.1708 0 .3415.0427.5122.1067.4482.1921.7683.6402.875 1.2805.1281.6829.0214 1.4726-.3201 2.2196-.5336 1.2164-1.5579 2.0914-2.4543 2.0914z"/><path d="M25.1404 10.4788c.1281 0 .2561.0213.3842.0853.3415.1494.5976.5336.6829 1.0458.1067.6189.0214 1.3445-.2987 2.0274-.4696 1.0885-1.3873 1.8781-2.1556 1.8781-.128 0-.2561-.0214-.3628-.064h0c-.3201-.1281-.4908-.4269-.5762-.6616-.2561-.6403-.1921-1.5793.1707-2.433.4909-1.0884 1.3872-1.878 2.1555-1.878m0-.6403c-1.0244 0-2.1555.9391-2.753 2.2836-.4482 1.003-.5122 2.0915-.1921 2.9238.1921.4908.5122.8323.9177 1.0244.1921.0853.4055.128.6402.128 1.0244 0 2.1556-.939 2.7318-2.2835.3628-.811.4695-1.6647.3414-2.4116s-.5122-1.2805-1.0671-1.5153c-.1707-.1067-.3841-.1494-.6189-.1494h0z" fill="#fff"/></g></svg>'

ICON_OFF='<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56"  stroke="none" stroke-linecap="round" stroke-linejoin="round" fill="#FF0000" fill-rule="evenodd"><path d="M.1067 27.0612c0 14.8965 12.0794 26.9546 26.9545 26.9546s26.9546-12.0581 26.9546-26.9546S41.9577.1067 27.0612.1067.1067 12.1647.1067 27.0612h0z" fill="#fff"/><path d="M3.7134 23.8387l2.0488-2.8598-.128 4.1189.5762-3.0945c1.7073 3.4574 5.8903 8.2379 9.7105 10.7989.4055.2774.7469.5762.9817.875.4909.1921.9817.2988 1.4726.3841.2561.0427.5335.0641.7896.0854s.5336.0214.7897.0214.5122-.0214.7683-.0427.5122-.0641.7682-.1067.5123-.0854.747-.1708c.2561-.064.4909-.128.747-.2134.2347-.064.4908-.1707.7256-.2561.2348-.1067.4695-.1921.7043-.3201s.4695-.2348.6829-.3628c.2348-.1067.4482-.2561.6829-.3842s.4482-.2774.683-.4054.4482-.2775.6616-.4056c.2134-.1493.4481-.2774.6616-.4268s.4481-.2774.6829-.4268l.2134-.1281.1067.0641 1.5366 1.0244-1.5579-.4055c-.1494.1707-.2988.3414-.4695.5122-.1921.1921-.4055.3841-.5976.5762-.2134.1707-.4269.3628-.6616.5122-.2348.1707-.4482.3201-.7043.4695-.4695.2988-.9817.5549-1.5152.7683-.2561.1067-.5336.2134-.7897.2988-.2774.0854-.5335.1707-.811.2347s-.5549.1281-.8323.1708-.5549.064-.8323.1067c-.5549.0213-1.1311.0213-1.686-.064-.2774-.0427-.5549-.0854-.8323-.1494s-.5336-.1494-.7897-.2348c-.4482-.1707-.8963-.3841-1.3018-.6402 0 0-1.4726.2134-.875 1.3232s1.4939 1.003 1.0671 2.3049c-.2988.7042-.7257 1.3872-1.1952 2.0274-.9817 1.3232-2.5183 2.497-2.3689 3.2013 6.9787 8.6007 22.7075 7.4055 28.6832-.2775-.0853-1.1098-1.8354-1.6433-3.0518-4.3537.3414.1067.8536.2561.8536.2348s-1.4512-2.3689-1.5152-2.6037l.939.064s-1.2378-1.5366-1.2805-1.686l1.2591-.1707s-1.5792-1.8141-1.6006-1.9634l1.6006.2561-1.75-2.1129h.8324l-.9817-1.4299c-.1708-.064-.3415-.1067-.5122-.1493l-.6403-.1921c-2.3903-.747-4.6525-1.4299-6.8294-2.7958-3.0518-1.8994-5.7836-4.2256-7.8324-6.0397l-4.1189-2.0061c-3.9482-.2988-7.6617-.1921-9.9239.2561l1.4513-2.4757-2.2196 2.6678c-.1494-.0427-.1921-.1281-.1921-.1281l.1495-3.2866-.7043 2.9665c-.2134-.1067-.4695-.1494-.7256-.1494a1.767 1.767 0 0 0-1.7714 1.7714c0 .8963.6616 1.6433 1.5366 1.75l-1.5153 3.0732z"/><path d="M6.1891 17.3508c-.2134-.0854-.4695-.1494-.7042-.1494a1.767 1.767 0 0 0-1.7714 1.7714c0 .8536.6189 1.5792 1.4299 1.75h.0427c.5335-.1708 1.6006-1.6007 1.4299-2.497-.064-.3201-.2134-.6189-.4269-.875h0zm15.5582-2.2836c-.3201-.875-.2348-2.0061.2134-3.0732.6402-1.4725 1.8567-2.4543 3.0092-2.4543a1.738 1.738 0 0 1 .6615.1281c.6616-.5976 1.4299-1.0884 2.2836-1.4299 4.7165-1.8781 11.6099 1.4726 13.3812 6.1037.8537 2.2409.5976 4.6952-.128 6.9361-.5976 1.8353-2.7744 4.4817-1.9634 6.4878-.3201-.0853-7.0641-2.1768-8.9422-3.372-3.0092-1.878-5.7196-4.1829-7.747-5.9756l-.0641-.064-6.8506-3.244c-.0854-.0427-.1708-.0854-.2348-.128.9817 0 4.7165.4481 6.3812.0853"/><g fill-rule="nonzero"><path d="M23.7746 15.8355c-.1921 0-.3628-.0427-.4908-.1067-.3415-.1494-.5976-.4268-.7684-.8536-.2987-.7257-.2134-1.7287.1921-2.6678.5336-1.2164 1.5366-2.0701 2.4543-2.0701.1708 0 .3415.0427.5122.1067.4482.1921.7683.6402.875 1.2805.1281.6829.0214 1.4726-.3201 2.2196-.5336 1.2164-1.5579 2.0914-2.4543 2.0914z"/><path d="M25.1404 10.4788c.1281 0 .2561.0213.3842.0853.3415.1494.5976.5336.6829 1.0458.1067.6189.0214 1.3445-.2987 2.0274-.4696 1.0885-1.3873 1.8781-2.1556 1.8781-.128 0-.2561-.0214-.3628-.064h0c-.3201-.1281-.4908-.4269-.5762-.6616-.2561-.6403-.1921-1.5793.1707-2.433.4909-1.0884 1.3872-1.878 2.1555-1.878m0-.6403c-1.0244 0-2.1555.9391-2.753 2.2836-.4482 1.003-.5122 2.0915-.1921 2.9238.1921.4908.5122.8323.9177 1.0244.1921.0853.4055.128.6402.128 1.0244 0 2.1556-.939 2.7318-2.2835.3628-.811.4695-1.6647.3414-2.4116s-.5122-1.2805-1.0671-1.5153c-.1707-.1067-.3841-.1494-.6189-.1494h0z" fill="#fff"/></g></svg>'

function svg() {
  if [ ! -d $ICONS_DIR ]; then
    mkdir -p $ICONS_DIR
  fi

	OUTPUT=$ICONS_DIR/$(basename $1)

  if [ -f $OUTPUT ]; then
    echo $OUTPUT
    return 0
  fi

	INPUT=$ICONS_DIR/$(basename $1).orig

	if [ ! -f $INPUT ]; then
		echo $2 > $INPUT
	fi

  if ! which rsvg-convert >/dev/null; then
    echo ""
    return 1
  fi

  rsvg-convert -w $ICONS_SIZE -h $ICONS_SIZE $INPUT > $OUTPUT

  if [ $? -ne 0 ]; then
    return 1
  fi

	echo $OUTPUT

	return 0
}

STATUS_JSON=$(curl -s $MULLVAD_API_ENDPOINT)
STATUS=$(echo $STATUS_JSON | jq -r .mullvad_exit_ip)

read -r -d '' TEXT << EOM
Connected: ${STATUS}
IP: $(echo $STATUS_JSON | jq -r .ip)
Country: $(echo $STATUS_JSON | jq -r .country)
City: $(echo $STATUS_JSON | jq -r .city)
Blacklisted: $(echo $STATUS_JSON | jq -r .blacklisted.blacklisted)
ISP: $(echo $STATUS_JSON | jq -r .organization)
EOM

if [[ $STATUS == "true" ]]; then
  echo "<img>$(svg "icon-on.svg" "${ICON_ON}")</img>"
else
  echo "<img>$(svg "icon-off.svg" "${ICON_OFF}")</img>"
fi

echo -e "<tool>$TEXT</tool><click>xdg-open https://mullvad.net/en/check/</click>"
